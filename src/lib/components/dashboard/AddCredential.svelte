<script lang="ts">
  import { fetchFolderUsers } from "../../apis/folder.api";
  import { selectedFolder } from "../../store/folder.store";
  import { showAddCredentialDrawer } from "../../store/ui.store";
  import { onMount } from "svelte";
  import { importPublicKey, encryptWithPublicKey } from "../../utils/crypto";
  import { addCredential } from "../../apis/credentials.api";
  import { fetchCredentailsByFolder } from "../../apis/credentials.api";
  import { User } from "../../dtos/user.dto";
  import { scale, fly } from "svelte/transition";

  import {
    AddCredentialFieldPayload,
    AddCredentialPayload,
    CredentialFields,
    userAccessPayload,
  } from "../../dtos/credential.dto";

  let credentialFields: AddCredentialFieldPayload[] = [];
  let description = "";
  let name = "";
  const addField = () => {
    let newField = { fieldName: "", fieldValue: "", sensitive: false };
    credentialFields = [...credentialFields, newField];
  };

  const removeField = (index: number) => {
    credentialFields.splice(index, 1);
    credentialFields = [...credentialFields];
  };
  const saveCredential = async () => {
    if ($selectedFolder === null) throw new Error("folder not selected");
    const unencryptedFields: CredentialFields[] = [];
    const toEncryptFields: CredentialFields[] = [];
    for (const field of credentialFields) {
      if (!field.sensitive) {
        unencryptedFields.push(field);
      } else {
        toEncryptFields.push(field);
      }
    }

    let encryptedFields = [];
    let addCredentialPaylod: AddCredentialPayload = {
      name: name,
      description: description,
      folderId: $selectedFolder.id,
      unencryptedFields: unencryptedFields,
      userAccessDetails: [],
    };
    for (const user of folderUsers) {
      let userPayload: userAccessPayload = {
        userId: user.id,
        encryptedFields: [],
      };
      const publicKey = await importPublicKey(user.publicKey);
      for (const toEncryptField of toEncryptFields) {
        const encryptedFieldValue = await encryptWithPublicKey(
          toEncryptField.fieldValue,
          publicKey
        );
        userPayload.encryptedFields.push({
          fieldName: toEncryptField.fieldName,
          fieldValue: encryptedFieldValue,
        });
      }
      encryptedFields.push(userPayload);
    }
    addCredentialPaylod.userAccessDetails = encryptedFields;

    await addCredential(addCredentialPaylod);
    if ($selectedFolder === null) throw new Error("folder not selected");
    fetchCredentailsByFolder($selectedFolder.id);
    showAddCredentialDrawer.set(false);
  };

  let folderUsers: User[] = [];
  onMount(async () => {
    credentialFields = [
      { fieldName: "Username", fieldValue: "", sensitive: false },
      { fieldName: "Password", fieldValue: "", sensitive: true },
      { fieldName: "URL", fieldValue: "", sensitive: false },
    ];
    if ($selectedFolder === null) throw new Error("folder not selected");
    folderUsers = await fetchFolderUsers($selectedFolder.id);
  });
</script>

<div class="bg-macchiato-surface2 rounded-md" in:fly>
  <div class="mb-2 p-4 mx-6 mt-6">
    <p class="font-normal text-4xl">Add Credential</p>
  </div>
  <div class="mx-6">
    <input
      class="flex-grow bg-macchiato-surface0 rounded-full w-[256px] h-10 ml-4"
      id="name"
      type="text"
      placeholder="name"
      bind:value={name}
    />
    {#each credentialFields as field, index}
      <div class="field-container rounded-sm transition relative">
        <div class="flex items-center justify-between p-4">
          <input
            class="flex-grow mr-2 bg-macchiato-surface0 rounded-full w-[256px] h-10"
            id={`key-${index}`}
            type="text"
            placeholder="Username"
            bind:value={field.fieldName}
          />
          <input
            class="flex-grow mr-2 bg-macchiato-surface0 rounded-full w-[256px] h-10"
            id={`value-${index}`}
            type="text"
            placeholder="Enter value"
            bind:value={field.fieldValue}
          />
          <div class="flex items-center justify-center">
            <input
              type="checkbox"
              id={`sensitive-${index}`}
              bind:checked={field.sensitive}
            />
            <label class="ml-2" for={`sensitive-${index}`}> Sensitive </label>
          </div>
        </div>
        <button
          class="rounded-md pr-2 pl-2 bg-macchiato-lavender flex justify-center items-center ml-5"
          on:click={() => removeField(index)}
        >
          delete
        </button>
      </div>
    {/each}
    <!-- Add secret btn -->
    <div class="flex mr-24">
      <button
        class="py-2 m-4 bg-macchiato-blue flex-1 flex justify-center items-center rounded-md"
        on:click={addField}
      >
        addField
      </button>
    </div>
  </div>
  <!-- Text Area -->
  <div>
    <textarea
      rows="2"
      class="bg-macchiato-surface0 w-full rounded-md ml-4 mr-4"
      bind:value={description}
      placeholder="Enter description about the secret"
    />
  </div>
  <div class="flex justify-start mt-4 pl-4 ml-6">
    <button
      class="bg-macchiato-blue px-[52px] py-2.5 rounded-full mb-6"
      on:click={saveCredential}>Add credential</button
    >
  </div>
</div>
